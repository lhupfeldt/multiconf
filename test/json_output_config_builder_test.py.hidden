# Copyright (c) 2012 Lars Hupfeldt Nielsen, Hupfeldt IT
# All rights reserved. This work is under a BSD license, see LICENSE.TXT.

import sys
from collections import OrderedDict
import pytest

from multiconf import ConfigRoot, ConfigItem, RepeatableConfigItem, InvalidUsageException, ConfigException, ConfigBuilder, MC_REQUIRED

from multiconf.decorators import nested_repeatables, named_as
from multiconf.envs import EnvFactory

from .utils.compare_json import compare_json
from .utils.tstclasses import RootWithName, RootWithAA, ItemWithAA


ef = EnvFactory()
pp = ef.Env('pp')
prod = ef.Env('prod')

ef2_prod = EnvFactory()
prod2 = ef2_prod.Env('prod')


_json_dump_configbuilder_expected_json_full = """{
    "__class__": "ItemWithYs",
    "__id__": 0000,
    "env": {
        "__class__": "Env",
        "name": "prod"
    },
    "ys": {
        "server1": {
            "__class__": "Y",
            "__id__": 0000,
            "b": 27,
            "name": "server1",
            "server_num": 1,
            "start": 1,
            "y_children": {
                "Hugo": {
                    "__class__": "YChild",
                    "__id__": 0000,
                    "a": 10,
                    "name": "Hugo"
                }
            },
            "ys": {
                "server3": {
                    "__class__": "Y",
                    "__id__": 0000,
                    "c": 28,
                    "name": "server3",
                    "server_num": 3,
                    "start": 3,
                    "y_children": {
                        "Hanna": {
                            "__class__": "YChild",
                            "__id__": 0000,
                            "a": 11,
                            "name": "Hanna"
                        },
                        "Herbert": {
                            "__class__": "YChild",
                            "__id__": 0000,
                            "a": 12,
                            "name": "Herbert"
                        }
                    },
                    "ys": {}
                },
                "server4": {
                    "__class__": "Y",
                    "__id__": 0000,
                    "c": 28,
                    "name": "server4",
                    "server_num": 4,
                    "start": 3,
                    "y_children": {
                        "Hanna": "#ref, id: 0000",
                        "Herbert": "#ref, id: 0000"
                    },
                    "ys": {}
                }
            },
            "YBuilder.builder.0000": "#ref later, id: 0000"
        },
        "server2": {
            "__class__": "Y",
            "__id__": 0000,
            "b": 27,
            "name": "server2",
            "server_num": 2,
            "start": 1,
            "y_children": {
                "Hugo": "#ref, id: 0000"
            },
            "ys": {
                "server3": "#ref, id: 0000",
                "server4": "#ref, id: 0000"
            },
            "YBuilder.builder.0000": {
                "__class__": "YBuilder",
                "__id__": 0000,
                "c": 28,
                "start": 3,
                "y_children": {
                    "Hanna": "#ref, id: 0000",
                    "Herbert": "#ref, id: 0000"
                }
            }
        }
    },
    "YBuilder.builder.0000": {
        "__class__": "YBuilder",
        "__id__": 0000,
        "b": 27,
        "start": 1,
        "y_children": {
            "Hugo": "#ref, id: 0000"
        },
        "YBuilder.builder.0000": "#ref, id: 0000",
        "ys": {
            "server3": "#ref, id: 0000",
            "server4": "#ref, id: 0000"
        }
    },
    "aaa": 2,
    "aaa #static": true
}"""

_json_dump_configbuilder_expected_json_repeatable_item = """{
    "__class__": "Y",
    "__id__": 0000,
    "b": 27,
    "name": "server2",
    "server_num": 2,
    "start": 1,
    "y_children": {
        "Hugo": {
            "__class__": "YChild",
            "__id__": 0000,
            "a": 10,
            "name": "Hugo"
        }
    },
    "ys": {
        "server3": {
            "__class__": "Y",
            "__id__": 0000,
            "c": 28,
            "name": "server3",
            "server_num": 3,
            "start": 3,
            "y_children": {
                "Hanna": {
                    "__class__": "YChild",
                    "__id__": 0000,
                    "a": 11,
                    "name": "Hanna"
                },
                "Herbert": {
                    "__class__": "YChild",
                    "__id__": 0000,
                    "a": 12,
                    "name": "Herbert"
                }
            },
            "ys": {}
        },
        "server4": {
            "__class__": "Y",
            "__id__": 0000,
            "c": 28,
            "name": "server4",
            "server_num": 4,
            "start": 3,
            "y_children": {
                "Hanna": "#ref, id: 0000",
                "Herbert": "#ref, id: 0000"
            },
            "ys": {}
        }
    },
    "YBuilder.builder.0000": {
        "__class__": "YBuilder",
        "__id__": 0000,
        "c": 28,
        "start": 3,
        "y_children": {
            "Hanna": "#ref, id: 0000",
            "Herbert": "#ref, id: 0000"
        }
    }
}"""

_json_dump_configbuilder_dont_dump_expected_json_full = """{
    "__class__": "ItemWithYs",
    "__id__": 0000,
    "env": {
        "__class__": "Env",
        "name": "prod"
    },
    "ys": {
        "server1": {
            "__class__": "Y",
            "__id__": 0000,
            "b": 27,
            "name": "server1",
            "server_num": 1,
            "start": 1,
            "y_children": {
                "Hugo": {
                    "__class__": "YChild",
                    "__id__": 0000,
                    "a": 10,
                    "name": "Hugo"
                }
            },
            "ys": {
                "server3": {
                    "__class__": "Y",
                    "__id__": 0000,
                    "c": 28,
                    "name": "server3",
                    "server_num": 3,
                    "start": 3,
                    "y_children": {
                        "Hanna": {
                            "__class__": "YChild",
                            "__id__": 0000,
                            "a": 11,
                            "name": "Hanna"
                        },
                        "Herbert": {
                            "__class__": "YChild",
                            "__id__": 0000,
                            "a": 12,
                            "name": "Herbert"
                        }
                    },
                    "ys": {}
                },
                "server4": {
                    "__class__": "Y",
                    "__id__": 0000,
                    "c": 28,
                    "name": "server4",
                    "server_num": 4,
                    "start": 3,
                    "y_children": {
                        "Hanna": "#ref, id: 0000",
                        "Herbert": "#ref, id: 0000"
                    },
                    "ys": {}
                }
            }
        },
        "server2": {
            "__class__": "Y",
            "__id__": 0000,
            "b": 27,
            "name": "server2",
            "server_num": 2,
            "start": 1,
            "y_children": {
                "Hugo": "#ref, id: 0000"
            },
            "ys": {
                "server3": "#ref, id: 0000",
                "server4": "#ref, id: 0000"
            }
        }
    },
    "aaa": 2,
    "aaa #static": true
}"""

_json_dump_configbuilder_dont_dump_expected_json_repeatable_item = """{
    "__class__": "Y",
    "__id__": 0000,
    "b": 27,
    "name": "server2",
    "server_num": 2,
    "start": 1,
    "y_children": {
        "Hugo": {
            "__class__": "YChild",
            "__id__": 0000,
            "a": 10,
            "name": "Hugo"
        }
    },
    "ys": {
        "server3": {
            "__class__": "Y",
            "__id__": 0000,
            "c": 28,
            "name": "server3",
            "server_num": 3,
            "start": 3,
            "y_children": {
                "Hanna": {
                    "__class__": "YChild",
                    "__id__": 0000,
                    "a": 11,
                    "name": "Hanna"
                },
                "Herbert": {
                    "__class__": "YChild",
                    "__id__": 0000,
                    "a": 12,
                    "name": "Herbert"
                }
            },
            "ys": {}
        },
        "server4": {
            "__class__": "Y",
            "__id__": 0000,
            "c": 28,
            "name": "server4",
            "server_num": 4,
            "start": 3,
            "y_children": {
                "Hanna": "#ref, id: 0000",
                "Herbert": "#ref, id: 0000"
            },
            "ys": {}
        }
    }
}"""

def test_json_dump_configbuilder():
    class YBuilder(ConfigBuilder):
        def __init__(self, start=1):
            super(YBuilder, self).__init__()
            self.start = start

        def build(self):
            for num in range(self.start, self.start + self.contained_in.aaa):
                Y(name='server%d' % num, server_num=num)

    @nested_repeatables('ys')
    class ItemWithYs(ConfigRoot):
        aaa = 2

    @named_as('ys')
    @nested_repeatables('y_children, ys')
    class Y(RepeatableConfigItem):
        def __init__(self, name, server_num):
            super(Y, self).__init__(mc_key=name)
            self.name = name
            self.server_num = server_num

    @named_as('y_children')
    class YChild(RepeatableConfigItem):
        def __init__(self, name, a):
            super(YChild, self).__init__(mc_key=name)
            self.name = name
            self.a = a

    with ItemWithYs(prod, ef) as cr:
        with YBuilder() as yb1:
            yb1.b = 27
            YChild(name='Hugo', a=10)
            with YBuilder(start=3) as yb2:
                yb2.c = 28
                YChild(name='Hanna', a=11)
                YChild(name='Herbert', a=12)

    assert compare_json(cr, _json_dump_configbuilder_expected_json_full, replace_builders=True, test_decode=True)
    assert compare_json(cr.ys['server2'], _json_dump_configbuilder_expected_json_repeatable_item, replace_builders=True, test_decode=True)

    assert compare_json(cr, _json_dump_configbuilder_dont_dump_expected_json_full, replace_builders=False, dump_builders=False, test_decode=True)
    assert compare_json(cr.ys['server2'], _json_dump_configbuilder_dont_dump_expected_json_repeatable_item, replace_builders=False, dump_builders=False, test_decode=True)




def test_json_dump_with_builders_containment_check():
    @named_as('inners')
    class InnerItem(RepeatableConfigItem):
        def __init__(self, name):
            super(InnerItem, self).__init__(mc_key=name)
            self.name = name

    class InnerBuilder(ConfigBuilder):
        def __init__(self):
            super(InnerBuilder, self).__init__()

        def build(self):
            InnerItem('innermost')

    @nested_repeatables('inners')
    class MiddleItem(RepeatableConfigItem):
        def __init__(self, name):
            super(MiddleItem, self).__init__(mc_key=name)
            self.name = name

    class MyMiddleBuilder(ConfigBuilder):
        def __init__(self, name):
            super(MyMiddleBuilder, self).__init__()
            self.name = name

        def build(self):
            with MiddleItem(name=self.name):
                pass

    class MyOuterBuilder(ConfigBuilder):
        def __init__(self):
            super(MyOuterBuilder, self).__init__()

        def build(self):
            with MyMiddleBuilder('base'):
                InnerBuilder()

    @nested_repeatables('MiddleItems')
    class MyOuterItem(ConfigItem):
        pass

    with RootWithName(prod2, ef2_prod) as cr:
        cr.name = 'myp'
        with MyOuterItem():
            MyOuterBuilder()

    cr.json(builders=True)
    # TODO
    assert True
