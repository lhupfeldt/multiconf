# Copyright (c) 2012 Lars Hupfeldt Nielsen, Hupfeldt IT
# All rights reserved. This work is under a BSD license, see LICENSE.TXT.

from __future__ import print_function

# pylint: disable=E0611
from pytest import raises

from .utils.utils import api_error, config_error, next_line_num

from .. import ConfigItem, ConfigBuilder, ConfigException
from ..envs import EnvFactory

ef1_prod = EnvFactory()
prod1 = ef1_prod.Env('prod')


def capie(line_num, *lines):
    return api_error(__file__, line_num, *lines)


def ce(line_num, *lines):
    return config_error(__file__, line_num, *lines)


def test_setattr_to_attribute_underscore_attribute_builder(capsys):
    msg = """Trying to set attribute '_b' on a config item. Atributes starting with '_' can not be set using item.setattr. Use assignment instead."""

    class CB(ConfigBuilder):
        def build(self):
            pass

    with raises(ConfigException) as exinfo:
        with ConfigItem(prod1, ef1_prod):
            with CB() as ci:
                errorline = next_line_num()
                ci.setattr('_b', default=7)

    _sout, serr = capsys.readouterr()
    assert serr == ce(errorline, msg)
